ARG BUILD_FROM

ARG OCTOPRINT_VERSION="1.3.12"
ARG CONFIG_DIR_SUFFIX="_experimental"
ARG PIP_FLAGS="--no-cache-dir"
ARG PYTHON_VERSION="python2"

FROM alpine:latest AS curaengine-legacy
ARG CURA_VERSION=15.04.6
WORKDIR /tmp
RUN apk add --no-cache --virtual .build-dependencies build-base libexecinfo-dev \
    && wget -qO- https://github.com/Ultimaker/CuraEngine/archive/${CURA_VERSION}.tar.gz | tar xz \
    && cd CuraEngine-${CURA_VERSION} \
    && make --quiet \
    && mkdir -p /root/copy/sbin/ \
    && mv build/CuraEngine /root/copy/sbin/CuraEngine \
    # Cleanup, should result in smaller stages (at the cost of time)
    && rm -rf /tmp \
    && apk del --no-cache .build-dependencies

FROM alpine:latest AS mjpg-streamer
WORKDIR /tmp
RUN apk add --no-cache --virtual .build-dependencies build-base cmake linux-headers libexecinfo-dev libjpeg-turbo-dev \
    && wget -qO- https://github.com/jacksonliam/mjpg-streamer/archive/master.tar.gz | tar xz \
    && cd mjpg-streamer-master/mjpg-streamer-experimental/ \
    && make --quiet \
    && make install --quiet \
    # Move files to /root/ for easier copy.
    && mkdir -p /root/copy/usr/local/lib/mjpg-streamer \
    && cp *.so /root/copy/usr/local/lib/mjpg-streamer/ \
    && mkdir -p /root/copy/usr/local/bin \
    && cp /usr/local/bin/mjpg_streamer /root/copy/usr/local/bin/ \
    # Cleanup
    && apk del --no-cache .build-dependencies \
    && rm -rf /tmp

FROM ${BUILD_FROM} AS final
ARG OCTOPRINT_VERSION
ARG CONFIG_DIR_SUFFIX
ARG PIP_FLAGS
ARG PYTHON_VERSION
ENV LANG C.UTF-8
ENV PYTHONPATH=/data/python
ENV PATH=${PATH}:/data/python/bin
ENV PYTHONUSERBASE=/data/python
# Install requirements to run
RUN apk add --no-cache --virtual .necessary supervisor haproxy ${PYTHON_VERSION} avahi-compat-libdns_sd dbus avahi postgresql-libs libjpeg ffmpeg
# Install OctoPrint
RUN echo "Installing OctoPrint" \
    && apk add --no-cache --virtual .build-dependencies \
       py3-virtualenv build-base ${PYTHON_VERSION}-dev linux-headers \
       avahi-compat-libdns_sd \
       postgresql-dev \
    && virtualenv --python=${PYTHON_VERSION} /data/python \
    && source /data/python/bin/activate \
    && pip install ${PIP_FLAGS} --upgrade pip \
    && pip install ${PIP_FLAGS} OctoPrint==${OCTOPRINT_VERSION} \
    # # Python2 PyBonjour
    && pip install ${PIP_FLAGS} https://goo.gl/SxQZ06 \
    # # Python3 PyBonjour
    # && pip install ${PIP_FLAGS} https://github.com/kounch/pybonjour-python3/archive/master.zip \
    && pip install ${PIP_FLAGS} psycopg2 \
    && find /data/python | grep -E "(__pycache__|\.pyc|\.pyo$)" | xargs rm -rf \
    && apk del --no-cache .build-dependencies \
    && mv /data/python /root/python
# Copy data from filesystem and previous stages
COPY FS/ /
COPY --from=curaengine-legacy /root/copy/ /
COPY --from=mjpg-streamer /root/copy /
# Make scripts executable
RUN chmod a+x /run.sh
RUN chmod a+x /run_dev.sh && dos2unix /run_dev.sh
RUN echo "Update config directory for all files" \
    && sed -i "s#/config/octoprint/#/config/octoprint${CONFIG_DIR_SUFFIX}/#g" /etc/supervisord.conf \
    && sed -i "s#/config/octoprint/#/config/octoprint${CONFIG_DIR_SUFFIX}/#g" /run.sh \
    && sed -i "s#/config/octoprint/#/config/octoprint${CONFIG_DIR_SUFFIX}/#g" /run_dev.sh
WORKDIR /
CMD [ "/run.sh" ]
